{% extends 'base.html' %}

{% block title %}Вход через Telegram{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header text-center">
                <h3>Авторизация</h3>
                <p class="text-muted">Войдите через Telegram для доступа к системе</p>
            </div>
            <div class="card-body">
                <!-- Telegram Login Widget (Callback версия) -->
                <div class="telegram-widget">
                    {% autoescape off %}
                        {{ telegram_login_widget }}
                    {% endautoescape %}
                </div>

                <!-- Loading indicator -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Проверяем данные авторизации...</p>
                </div>

                <!-- Error display -->
                <div id="error-message" class="alert alert-danger" style="display: none;"></div>

                <!-- Alternative manual widget (если автоматический не работает) -->
                <div class="text-center mt-4">
                    <p class="text-muted small">
                        Если кнопка не загружается, попробуйте перезагрузить страницу
                    </p>
                </div>
            </div>
            <div class="card-footer text-center text-muted">
                <small>
                    При входе вы соглашаетесь с условиями использования сервиса
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Глобальная функция для обработки callback от Telegram Widget
function onTelegramAuth(user) {
    console.log('Telegram auth data:', user);

    // Показываем индикатор загрузки
    document.getElementById('loading').style.display = 'block';

    // Отправляем данные на сервер для проверки
    fetch('/telegram-callback/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(user)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';

        if (data.success) {
            // Успешная авторизация - редирект
            window.location.href = data.redirect_url || '/dashboard/';
        } else {
            // Показываем ошибку
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = data.error || 'Произошла ошибка авторизации';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        console.error('Error:', error);

        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'Ошибка соединения с сервером';
        errorDiv.style.display = 'block';
    });
}

// Альтернативная функция для ручной обработки (если нужно)
function manualTelegramAuth() {
    // Открываем попап для авторизации
    const botName = '{{ bot_name }}'; // Передаем из контекста
    const authUrl = `https://oauth.telegram.org/auth?bot_id=${botName}&origin=${encodeURIComponent(window.location.origin)}&return_to=${encodeURIComponent(window.location.href)}`;

    const popup = window.open(authUrl, 'telegram-auth', 'width=400,height=500');

    // Слушаем сообщения от popup
    window.addEventListener('message', function(event) {
        if (event.origin === 'https://oauth.telegram.org') {
            popup.close();
            if (event.data && event.data.user) {
                onTelegramAuth(event.data.user);
            }
        }
    });
}
</script>
{% endblock %}
